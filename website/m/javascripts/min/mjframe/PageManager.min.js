/*global Package *//*global Import *//*global Class *//*global ClassUtils *//*global NavigationManager *//*global PageManager *//*global View *//*global GenericLoader *//*global LayoutAnimation */Package("mjframe",[Import("mjframe.NavigationManager"),Import("mjframe.View"),Class("public singleton PageManager",{_public_static:{EVENT_PAGE_CHANGE:"PageManager.EventPageChange",DO_NOT_REDIRECT_FOR:["/create/uploadcomputer_tab","/create/uploadfacebook_tab","/create/uploadinstagram_tab"]},_public:{initialized:!1,pages:{},pagesByUrl:{},pagesByRegExp:{},activePages:[],activePopups:[],history:[],showingInProgress:!1,queuedPage:null,init:function(){if(PageManager.initialized)return;NavigationManager.getInstance().on(NavigationManager.EVENT_URL_CHANGE,Poof.retainContext(this,this.onUrlChange));PageManager.initialized=!0},registerPage:function(e,t,n,r,i,s){this.initialized||this.init();typeof r=="undefined"&&(r=!1);typeof i=="undefined"&&(i=!1);typeof s=="undefined"&&(s=null);var o={pageName:e,className:t,url:n,useRegExp:r,popup:i,pageUrl:s,instance:null};this.pages[e]=o;r?this.pagesByRegExp[n]=o:this.pagesByUrl[n]=o},getPageNameForUrl:function(e){if(e in this.pagesByUrl)return this.pagesByUrl[e];for(var t in this.pagesByRegExp)if((new RegExp(this.pagesByRegExp[t].url)).test(e))return this.pagesByRegExp[t];return null},getCurrentPage:function(){return this.activePages.length===0?null:this.activePages[this.activePages.length-1]},showPage:function(e,t,n,r,i,s){if(!(t in window)){this.log("page "+t+" is not loaded.");return}if(i===null||typeof i=="undefined")i=LayoutAnimation.DIRECTION_FORWARD;var o=ClassUtils.getClassByName(t).getInstance();o.pageInfo=e;if(this.activePages.indexOf(o)!==-1)return;n&&this.history.push({url:n,page:o});"GenericLoader"in window&&GenericLoader.getInstance().show();this.showingInProgress=!0;var u=this;o.on(View.EVENT_INIT,Poof.retainContext(this,function(){"GenericLoader"in window&&GenericLoader.getInstance().hide();var t=function(){e.popup?u.activePopups.push(o):u.activePages.push(o);o.on(View.EVENT_SHOW,function(){u.showingInProgress=!1;o.off(View.EVENT_SHOW);u.showQueuedPage()});o.show(i);typeof s=="function"&&s();u.dispatch(PageManager.EVENT_PAGE_CHANGE,o)};if(e.popup)u.activePages.length===0?this.showPageByInfo(this.getPageNameForUrl(e.pageUrl),null,null,LayoutAnimation.DIRECTION_FORWARD,function(){t()}):t();else{this.hideCurrentPage(i);t()}}));o.setRequestUrl(n);o.setPageData(r);o.init()},queuePage:function(e,t,n,r){this.queuedPage={pageInfo:e,requestUrl:t,pageData:n,direction:r}},showQueuedPage:function(){if(this.queuedPage){this.showPageByInfo(this.queuedPage.pageInfo,this.queuedPage.requestUrl,this.queuedPage.pageData,this.queuedPage.direction);this.queuedPage=null}},showPageByInfo:function(e,t,n,r,i){this.hidePopups(!1);if(e===null)if(PageManager.DO_NOT_REDIRECT_FOR.indexOf(t)===-1){window.console.warn("[PageManager] page "+t+" not found. Redirecting to root");NavigationManager.getInstance().goTo("/")}else window.console.warn("[PageManager] page "+t+" not found, but not redirecting.");else{"GenericLoader"in window&&GenericLoader.getInstance().show();Import(e.className,Poof.retainContext(this,function(s){this.onPageReady(e,s,t,n,r,i)}))}},hidePage:function(e,t){e.off(View.EVENT_INIT);e.hide(t);e.pageInfo.popup?this.activePopups.splice(this.activePopups.indexOf(e),1):this.activePages.splice(this.activePages.indexOf(e),1)},hidePopups:function(e){typeof e=="undefined"&&(e=!0);var t,n;if(e)if(this.history.length>1){var r=!1;for(t=0,n=this.history.length-2;t<n;t++)if(!this.history[n-t].page.pageInfo.popup){NavigationManager.getInstance().goTo(this.history[n-t].url);r=!0;break}r||NavigationManager.getInstance().goTo(this.history[0].url)}else NavigationManager.getInstance().goTo(this.activePopups[this.activePopups.length-1].pageInfo.pageUrl);for(t=0,n=this.activePopups.length;t<n;t++)this.hidePage(this.activePopups[t],LayoutAnimation.DIRECTION_FORWARD)},hideCurrentPage:function(e){var t=this.getCurrentPage();if(t===null)return;this.hidePage(t,e)},onUrlChange:function(e){var t=this.getPageNameForUrl(e.data.url),n=e.data.url,r=e.data.data,i=e.data.direction;if(this.showingInProgress){this.queuePage(t,n,r,i);return}this.showPageByInfo(t,n,r,i)},onPageReady:function(e,t,n,r,i,s){"GenericLoader"in window&&GenericLoader.getInstance().hide();this.showPage(e,t.className,n,r,i,s)}}})]);