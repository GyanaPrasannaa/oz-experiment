/*global Poof *//*global Package *//*global Import *//*global Class *//*global TextUtil *//*global Modernizr *//*global JourneyToOzScrollController *//*global ThreeUtil */Package("controller",[Import("util.TextUtil"),Class("public singleton JourneyToOzScrollController",{_public_static:{TRANSITION_START_OFFSET:.2,TRANSITION_END_OFFSET:0,TRANSITION_POWER:1},_public:{$container:null,$images:null,$paragraphs:null,$lines:null,$contents:null,enabled:!1,startPos:{x:0,y:0},lastPos:{x:0,y:0},dragging:!1,offsetsByContentIndex:{},heightsByContentIndex:{},JourneyToOzScrollController:function(){},init:function(e){this.$container=e;this.$images=e.find(".image");this.$paragraphs=e.find(".paragraph");this.$paragraphs.find("p").each(function(){TextUtil.getInstance().breakIntoLines($(this))});this.$lines=this.$container.find("p");this.$contents=this.$container.find(".image, p");var t=0,n=this;this.$contents.each(function(){n.offsetsByContentIndex[t]=$(this).position().top;n.heightsByContentIndex[t++]=$(this).height()});ThreeUtil.getInstance().setPerspective(this.$container,600)},enable:function(){this.enabled=!0;$(document).bind(Modernizr.touch?"touchstart.journey":"mousedown.journey",Poof.retainContext(this,this.onTouchStart));$(document).bind(Modernizr.touch?"touchend.journey":"mouseup.journey",Poof.retainContext(this,this.onTouchEnd));$(document).bind(Modernizr.touch?"touchmove.journey":"mousemove.journey",Poof.retainContext(this,this.onTouchMove))},disable:function(){this.enabled=!1;$(document).unbind("touchstart.journey");$(document).unbind("touchend.journey");$(document).unbind("touchmove.journey");$(document).unbind("mousedown.journey");$(document).unbind("mouseup.journey");$(document).unbind("mousemove.journey")},registerStartValues:function(e){var t=e.originalEvent;t.touches?this.startPos={x:t.touches[0].pageX,y:t.touches[0].pageY}:this.startPos={x:t.pageX,y:t.pageY};this.containerStartPosition={x:this.$container.position().left,y:this.$container.position().top}},registerEndValues:function(e){var t=e.originalEvent;this.applyMomentum()},registerMoveValues:function(e){var t=e.originalEvent;t.touches?this.lastPos={x:t.touches[0].pageX,y:t.touches[0].pageY}:this.lastPos={x:t.pageX,y:t.pageY}},applyPosition:function(){var e=this.lastPos.y-this.startPos.y,t=this.containerStartPosition.y+e;this.$container.css("top",t)},apply3D:function(){var e=$(window).height(),t=this.$container.position().top,n=e*JourneyToOzScrollController.TRANSITION_START_OFFSET,r=-e*JourneyToOzScrollController.TRANSITION_END_OFFSET,i=e-e*JourneyToOzScrollController.TRANSITION_START_OFFSET,s=n-r,o=0,u=this;this.$contents.each(function(){var e=$(this),r=u.offsetsByContentIndex[o]+u.heightsByContentIndex[o]*.5+t,a=0;r<n?a=(r-n)/s:r>i&&(a=(r-i)/s);a=Math.pow(a,JourneyToOzScrollController.TRANSITION_POWER);if(a>0){e.css("opacity",1-a);ThreeUtil.getInstance().rotate(e,0,a*90,0)}else if(a<0){e.css("opacity",1+a);ThreeUtil.getInstance().rotate(e,0,a*-90,0)}else{e.css("opacity",1);ThreeUtil.getInstance().rotate(e,0,0,0)}o++})},applyMomentum:function(){},onTouchStart:function(e){this.registerStartValues(e);this.dragging=!0},onTouchEnd:function(e){this.dragging=!1;this.registerEndValues(e);this.applyMomentum()},onTouchMove:function(e){if(this.dragging){this.registerMoveValues(e);this.applyPosition();this.apply3D()}}}})]);