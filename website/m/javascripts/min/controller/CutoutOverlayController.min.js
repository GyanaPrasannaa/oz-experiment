/*global Poof *//*global Package *//*global Class *//*global CutoutOverlayController *//*global CutoutControls *//*global Modernizr *//*global TweenLite *//*global Power3 */Package("controller",[Class("public singleton CutoutOverlayController",{_public_static:{SCROLLING_SPEED:1,MIN_DRAG_DISTANCE_TO_CHANGE:40,SNAP_TO_AXIS:!0,STRUCTURE:"gallery"},_public:{$overlaysContainer:null,$overlays:null,$overlaysEarth:null,$overlaysOz:null,$selectedOverlay:null,enabled:!1,selectedOverlayIndex:-1,selectedOverlayIsOz:!1,dragging:!1,dragStartX:-1,lastTouchX:-1,dragStartY:-1,lastTouchY:-1,lastSnapDirection:null,overlayTween:null,overlaysTweenProperties:{marginLeft:0,marginTop:0},tweenInProgress:!1,CutoutOverlayController:function(){window.location.search.indexOf("mode=grid")!==-1&&(CutoutOverlayController.STRUCTURE="grid")},initFromContainer:function(e){this.$overlaysContainer=e;this.$overlays=e.find(".overlay");this.$overlaysEarth=e.find(".overlay.earth");this.$overlaysOz=e.find(".overlay.oz");this.initOverlayPositions();this.bindEvents()},initOverlayPositions:function(){var e;for(e=0;e<this.$overlaysEarth.length;e++)$(this.$overlaysEarth[e]).css("top",100*e+"%");for(e=0;e<this.$overlaysOz.length;e++)$(this.$overlaysOz[e]).css("top",100*e+"%");this.selectOverlayIndex(0,!1);CutoutOverlayController.STRUCTURE==="gallery"&&this.setGalleryMode()},bindEvents:function(){this.$overlaysContainer.bind(Modernizr.touch?"touchstart":"mousedown",Poof.retainContext(this,this.onOverlaysTouchDown));$(window).bind(Modernizr.touch?"touchend":"mouseup",Poof.retainContext(this,this.onOverlaysTouchUp));$(window).bind(Modernizr.touch?"touchmove":"mousemove",Poof.retainContext(this,this.onOverlaysTouchMove))},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},getSelectedId:function(){return this.selectedOverlayIndex+1+(this.selectedOverlayIsOz?"oz":"")},canInteract:function(){return this.enabled&&(!this.tweenInProgress||CutoutOverlayController.STRUCTURE!=="gallery")},snap:function(){var e=this.$selectedOverlay,t=-parseInt(this.$overlaysContainer.css("margin-left"),10)-(this.selectedOverlayIsOz?$(window).width():0),n=-parseInt(this.$overlaysContainer.css("margin-top"),10)-parseInt(e.css("top"),10);if(Math.abs(t)>Math.abs(n)){this.lastSnapDirection="x";if(t>CutoutOverlayController.MIN_DRAG_DISTANCE_TO_CHANGE&&!this.selectedOverlayIsOz)this.snapToIndex(this.selectedOverlayIndex,!0);else if(t<-CutoutOverlayController.MIN_DRAG_DISTANCE_TO_CHANGE&&this.selectedOverlayIsOz)this.snapToIndex(this.selectedOverlayIndex,!1);else{this.lastSnapDirection=null;this.snapToIndex(this.selectedOverlayIndex,this.selectedOverlayIsOz)}}else{this.lastSnapDirection="y";if(n>CutoutOverlayController.MIN_DRAG_DISTANCE_TO_CHANGE&&this.selectedOverlayIndex<this.$overlaysEarth.length-1)this.snapToIndex(this.selectedOverlayIndex+1,this.selectedOverlayIsOz);else if(n<-CutoutOverlayController.MIN_DRAG_DISTANCE_TO_CHANGE&&this.selectedOverlayIndex>0)this.snapToIndex(this.selectedOverlayIndex-1,this.selectedOverlayIsOz);else{this.lastSnapDirection=null;this.snapToIndex(this.selectedOverlayIndex,this.selectedOverlayIsOz)}}},snapToIndex:function(e,t){var n=t?$(this.$overlaysOz[e]):$(this.$overlaysEarth[e]);this.overlaysTweenProperties.marginLeft=parseInt(this.$overlaysContainer.css("margin-left"),10);this.overlaysTweenProperties.marginTop=parseInt(this.$overlaysContainer.css("margin-top"),10);this.overlayTween&&this.overlayTween.kill();this.tweenInProgress=!0;this.overlayTween=TweenLite.to(this.overlaysTweenProperties,.6,{marginLeft:t?-$(window).width():0,marginTop:-parseInt(n.css("top"),10),ease:Power3.easeOut,onUpdate:Poof.retainContext(this,this.onOverlaysTweenUpdate),onComplete:Poof.retainContext(this,this.onOverlaysTweenComplete)});this.selectOverlayIndex(e,t)},selectOverlayIndex:function(e,t){this.selectedOverlayIndex=e;this.selectedOverlayIsOz=t;this.$selectedOverlay=$(this.$overlaysEarth[e]);CutoutControls.getInstance().setCurrentIndex(e);CutoutControls.getInstance().setOz(t&&(this.lastSnapDirection!=="y"||CutoutOverlayController.STRUCTURE!=="gallery"))},setGalleryMode:function(){this.selectOverlayIndex(this.selectedOverlayIndex,!1);this.$overlaysContainer.css("margin-left",0);$(this.$overlaysOz[this.selectedOverlayIndex]).removeClass("overlayEarth"+(this.selectedOverlayIndex+1)).addClass("overlayOz"+(this.selectedOverlayIndex+1));this.selectedOverlayIndex>0&&$(this.$overlaysOz[this.selectedOverlayIndex-1]).removeClass("overlayOz"+this.selectedOverlayIndex).addClass("overlayEarth"+this.selectedOverlayIndex);this.selectedOverlayIndex<this.$overlaysOz.length-1&&$(this.$overlaysOz[this.selectedOverlayIndex+1]).removeClass("overlayOz"+(this.selectedOverlayIndex+2)).addClass("overlayEarth"+(this.selectedOverlayIndex+2))},onOverlaysTouchDown:function(e){if(!this.dragging&&this.canInteract()){this.dragging=!0;var t=e.originalEvent.touches?e.originalEvent.touches[0].pageX:e.originalEvent.pageX,n=e.originalEvent.touches?e.originalEvent.touches[0].pageY:e.originalEvent.pageY;this.dragStartX=this.lastTouchX=t;this.dragStartY=this.lastTouchY=n;this.overlayTween&&this.overlayTween.kill()}},onOverlaysTouchUp:function(e){Poof.suppressUnused(e);if(this.dragging&&this.canInteract()){this.dragging=!1;this.snap()}},onOverlaysTouchMove:function(e){if(this.dragging&&this.canInteract()){var t=e.originalEvent.touches?e.originalEvent.touches[0].pageX:e.originalEvent.pageX,n=e.originalEvent.touches?e.originalEvent.touches[0].pageY:e.originalEvent.pageY,r=(t-this.lastTouchX)*CutoutOverlayController.SCROLLING_SPEED,i=(n-this.lastTouchY)*CutoutOverlayController.SCROLLING_SPEED,s=t-this.dragStartX,o=n-this.dragStartY,u=parseInt(this.$overlaysContainer.css("margin-left"),10),a=parseInt(this.$overlaysContainer.css("margin-top"),10),f=u+r,l=a+i;if(Math.abs(s)>Math.abs(o)){this.$overlaysContainer.css("margin-left",f);CutoutOverlayController.SNAP_TO_AXIS&&this.$overlaysContainer.css("margin-top",-parseInt(this.$selectedOverlay.css("top"),10))}else{this.$overlaysContainer.css("margin-top",l);CutoutOverlayController.SNAP_TO_AXIS&&this.$overlaysContainer.css("margin-left",this.selectedOverlayIsOz?-$(window).width():0)}this.lastTouchX=t;this.lastTouchY=n}},onOverlaysTweenUpdate:function(){this.$overlaysContainer.css("margin-left",this.overlaysTweenProperties.marginLeft);this.$overlaysContainer.css("margin-top",this.overlaysTweenProperties.marginTop)},onOverlaysTweenComplete:function(){CutoutOverlayController.STRUCTURE==="gallery"&&this.lastSnapDirection==="y"&&this.setGalleryMode();this.tweenInProgress=!1}}})]);