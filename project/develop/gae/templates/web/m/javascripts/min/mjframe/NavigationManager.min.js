/*global Package *//*global Import *//*global Class *//*global NavigationManager */Package("mjframe",[Class("public singleton NavigationManager",{_public_static:{EVENT_BROWSER_INCOMPATIBLE:"NavigationManager.EventBrowserIncompatible",EVENT_URL_CHANGE:"NavigationManager.EventUrlChange"},_public:{currentPageData:null,currentDirection:null,init:function(){this.supportsHistory()?this.initHistoryMode():this.supportsHash()?this.initHashMode():this.dispatch(NavigationManager.EVENT_BROWSER_INCOMPATIBLE)},supportsHash:function(){return"onhashchange"in window},supportsHistory:function(){return"history"in window&&"pushState"in window.history&&!window.navigator.userAgent.match(/Android/i)},goTo:function(e,t,n){if(this.getCurrentPage()===e)return!1;if(this.supportsHistory())return this.goToHistory(e,t,n);if(this.supportsHash())return this.goToHash(e,t,n)},getCurrentPage:function(){var e=window.location.toString().substring(window.location.toString().indexOf(window.location.host)+window.location.host.length,window.location.toString().length);e.indexOf(MjConfig.getInstance().rootPath)===0&&(e=e.substring(MjConfig.getInstance().rootPath.length,e.length));while(e.indexOf("/")===0)e=e.substring(1,e.length);while(e.indexOf("#")!==-1)e=e.replace("#","");while(e.lastIndexOf("/")===e.length-1&&e!=="")e=e.substring(0,e.length-1);e=e.indexOf("?")===-1?e:e.substring(0,e.indexOf("?"));return e===""?"/":e.indexOf("/")===0?e:"/"+e},goToHash:function(e,t,n){e=NavigationManager.getInstance().parsePageName(e);if(e===null||typeof e=="undefined")return;this.currentPageData=t;this.currentDirection=n;window.console.log("!!!!GOTO-HASH::: !!!: "+this.getCurrentPage()+" : "+e,n);window.location.href=window.location.protocol+"//"+window.location.host+MjConfig.getInstance().rootPath+"/#"+e},goToHistory:function(e,t,n){var r=NavigationManager.getInstance().parsePageName(e);if(r===null||typeof r=="undefined")return;r=MjConfig.getInstance().rootPath+(r.indexOf("/")===0?r:"/"+r);r=r.replace("//","/");r.indexOf("/")===0&&(r=r.substring(1,r.length));this.currentPageData=t;this.currentDirection=n;window.console.log(e);try{window.history.pushState(t,"","/"+r)}catch(i){return this.goToHash(e,t)}window.console.log("!!!!GOTO-HISTORY::: !!!: "+this.getCurrentPage()+" : "+e,n);NavigationManager.getInstance().onUrlChange()},parsePageName:function(e){var t=NavigationManager.getInstance().getCurrentPage();t==="/"&&e.indexOf("/")!==0&&(e="/"+e);if(e===null||typeof e=="undefined")return null;e.lastIndexOf("/")===e.length-1&&e!=="/"&&(e=e.substring(0,e.length-1));return e.indexOf("/")===0?e.substring(1,e.length):t+(t==="/"?"":"/")+e},initHistoryMode:function(){window.addEventListener("popstate",Poof.retainContext(this,this.onPopState))},initHashMode:function(){window.onhashchange=Poof.retainContext(this,this.onHashChange)},onHashChange:function(e){var t=window.location.hash.substring(1,window.location.hash.length);this.currentPage!==t&&NavigationManager.getInstance().onUrlChange(t)},onPopState:function(e){NavigationManager.getInstance().onUrlChange()},onUrlChange:function(){this.log("onUrlChange",NavigationManager.getInstance().getCurrentPage());NavigationManager.getInstance().dispatch(NavigationManager.EVENT_URL_CHANGE,{url:NavigationManager.getInstance().getCurrentPage(),data:this.currentPageData,direction:this.currentDirection})}}})]);