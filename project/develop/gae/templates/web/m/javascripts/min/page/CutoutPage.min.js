/*global Poof *//*global Package *//*global Import *//*global Class *//*global console *//*global UploadController *//*global PhotoPositionController *//*global CutoutOverlayController *//*global OverlayController *//*global SharingController *//*global CutoutControls */Package("page",[Import("mjframe.Page"),Import("controller.CutoutOverlayController"),Import("controller.UploadController"),Import("controller.PhotoPositionController"),Import("controller.SharingController"),Import("view.CutoutControls"),Class("public singleton CutoutPage extends Page",{_public:{$cutoutOverlays:null,$uploadButton:null,$shareButton:null,$shareOnGoogleButton:null,$shareOnFacebookButton:null,$shareOnTwitterButton:null,$shareCloseButton:null,$fileInput:null,$userPhoto:null,$photoFrame:null,$uploadingOverlay:null,$uploadProgress:null,$repositionOverlay:null,$sharingOverlay:null,$shareLinkInput:null,userPhoto:null,shareLink:null,CutoutPage:function(){this._super()},compile:function(){this._super();this.$cutoutOverlays=$("#cutoutOverlays");this.$fileInput=$("#fileInput");this.$userPhoto=$("#userPhoto");this.$photoFrame=$("#photoFrame");this.$uploadButton=$("#uploadButton");this.$shareButton=$("#cutoutShareButton");this.$shareOnGoogleButton=$("#shareGoogleButton");this.$shareOnFacebookButton=$("#shareFacebookButton");this.$shareOnTwitterButton=$("#shareTwitterButton");this.$shareCloseButton=$("#shareCloseButton");this.$uploadingOverlay=$("#uploadingOverlay");this.$uploadProgress=this.$uploadingOverlay.find(".text.progress");this.$repositionOverlay=$("#repositionOverlay");this.$repositionDoneButton=$("#repositionDoneButton");this.$sharingOverlay=$("#sharingOverlay");this.$shareLinkInput=$("#shareLinkInput")},bindEvents:function(){this._super();this.$repositionDoneButton.bind("click",Poof.retainContext(this,this.onRepositionDoneButtonClick));this.$shareButton.bind("click",Poof.retainContext(this,this.onShareButtonClick));this.$shareOnGoogleButton.bind("click",Poof.retainContext(this,this.onShareOnGoogleButtonClick));this.$shareOnFacebookButton.bind("click",Poof.retainContext(this,this.onShareOnFacebookButtonClick));this.$shareOnTwitterButton.bind("click",Poof.retainContext(this,this.onShareOnTwitterButtonClick));this.$shareCloseButton.bind("click",Poof.retainContext(this,this.onShareCloseButtonClick));this.$shareLinkInput.bind("mouseup, touchend",Poof.retainContext(this,this.onShareLinkInputUp));this.$shareLinkInput.bind("change, keydown, keyup",Poof.retainContext(this,this.onShareLinkInputChange));SharingController.getInstance().on(SharingController.EVENT_LINK_READY,Poof.retainContext(this,this.onShareLinkReady))},onReady:function(){this._super();OverlayController.getInstance().showCutoutOverlay();CutoutOverlayController.getInstance().initFromContainer(this.$cutoutOverlays);CutoutControls.getInstance().show();UploadController.getInstance().init(this.$fileInput);this.$uploadButton=$("#uploadButton");UploadController.getInstance().on(UploadController.EVENT_UPLOAD_START,Poof.retainContext(this,this.onUploadStart));UploadController.getInstance().on(UploadController.EVENT_UPLOAD_PROGRESS,Poof.retainContext(this,this.onUploadProgress));UploadController.getInstance().on(UploadController.EVENT_UPLOAD_COMPLETE,Poof.retainContext(this,this.onUploadComplete));PhotoPositionController.getInstance().init(this.$userPhoto,this.$photoFrame);this.setCutoutSelectionMode()},canShare:function(){return this.userPhoto!==null},showUploadButton:function(){$("#uploadButton").fadeIn()},hideUploadButton:function(){$("#uploadButton").fadeOut()},setUserPhoto:function(e){this.$userPhoto.attr("src",e.src)},showUserPhoto:function(){console.log("showing user photo",this.$userPhoto);this.$userPhoto.fadeIn()},hideUserPhoto:function(){this.$userPhoto.fadeOut()},loadUserPhoto:function(e){this.userPhoto=new Image;this.userPhoto.onload=Poof.retainContext(this,this.onPhotoLoadComplete);this.userPhoto.src=e.url},showLoading:function(){this.$uploadingOverlay.fadeIn()},hideLoading:function(){this.$uploadingOverlay.fadeOut()},setLoadingProgress:function(e){this.$uploadProgress.text(parseInt(e*100,10))},showPhotoPositioningOverlay:function(){this.$repositionOverlay.fadeIn()},hidePhotoPositioningOverlay:function(){this.$repositionOverlay.fadeOut()},showSharingOverlay:function(){this.hideShareButton();this.$shareLinkInput.val(this.shareLink);this.$sharingOverlay.fadeIn()},hideSharingOverlay:function(){this.$sharingOverlay.fadeOut();this.canShare()&&this.showShareButton()},showShareButton:function(){this.$shareButton.fadeIn()},hideShareButton:function(){this.$shareButton.fadeOut()},setPhotoPositioningMode:function(){CutoutOverlayController.getInstance().disable();PhotoPositionController.getInstance().enable();this.showPhotoPositioningOverlay()},setCutoutSelectionMode:function(){PhotoPositionController.getInstance().disable();this.hidePhotoPositioningOverlay();CutoutOverlayController.getInstance().enable()},getCutoutInfoObject:function(){var e=PhotoPositionController.getInstance().getPositionInfoObject();return{cutout:{photo:{id:UploadController.getInstance().fileId,position:e.position,size:e.size,orientation:e.orientation},overlay:{id:CutoutOverlayController.getInstance().getSelectedId()}}}},onUploadStart:function(e){Poof.suppressUnused(e);this.hideUserPhoto();this.hideUploadButton();this.showLoading()},onUploadProgress:function(e){this.setLoadingProgress(e.data.progress)},onUploadComplete:function(e){this.loadUserPhoto(e.data)},onPhotoLoadComplete:function(e){Poof.suppressUnused(e);PhotoPositionController.getInstance().updateData();this.hideLoading();this.setUserPhoto(this.userPhoto);PhotoPositionController.getInstance().setInitialPosition();this.showUserPhoto();this.setPhotoPositioningMode()},onRepositionDoneButtonClick:function(e){Poof.suppressUnused(e);this.setCutoutSelectionMode();this.showShareButton()},onShareButtonClick:function(e){Poof.suppressUnused(e);SharingController.getInstance().requestShareLink(this.getCutoutInfoObject())},onShareLinkReady:function(e){this.shareLink=e.data.url;this.showSharingOverlay()},onShareOnGoogleButtonClick:function(e){Poof.suppressUnused(e);SharingController.getInstance().shareLinkOnGoogle(this.shareLink)},onShareOnFacebookButtonClick:function(e){Poof.suppressUnused(e);SharingController.getInstance().shareLinkOnFacebook(this.shareLink)},onShareOnTwitterButtonClick:function(e){Poof.suppressUnused(e);SharingController.getInstance().shareLinkOnTwitter(this.shareLink)},onShareLinkInputUp:function(e){e.preventDefault();e.stopPropagation();this.$shareLinkInput[0].setSelectionRange(0,9999)},onShareLinkInputChange:function(e){e.preventDefault();e.stopPropagation();this.$shareLinkInput.val(this.shareLink)},onShareCloseButtonClick:function(e){Poof.suppressUnused(e);this.hideSharingOverlay()}}})]);