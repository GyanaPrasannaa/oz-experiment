/*global Poof *//*global Package *//*global Class *//*global Modernizr *//*global PhotoPositionController */Package("controller",[Class("public singleton PhotoPositionController",{_public_static:{INITIAL_PHOTO_WIDTH:.3,INITIAL_PHOTO_OFFSET_TOP:.25,MIN_PHOTO_WIDTH:.2,MIN_PHOTO_HEIGHT:.2,MAX_PHOTO_WIDTH:.9,MAX_PHOTO_HEIGHT:.9,OVERLAY_ASPECT_RATIO:570/820},_public:{$photo:null,$frame:null,enabled:!1,photoAspectRatio:1,photoAspectRatioCorrected:!1,controlModePosition:!1,controlModeScale:!1,controlModeRotation:!1,startPos1:{x:0,y:0},startPos1b:{x:0,y:0},startPos2:{x:0,y:0},lastPos1:{x:0,y:0},lastPos2:{x:0,y:0},photoStartPosition:{x:0,y:0},photoStartSize:{width:0,height:0},photoStartMargins:{left:0,top:0},photoStartRotation:0,photoRotation:0,numTouches:0,PhotoPositionController:function(){},init:function(e,t){this.$photo=e;this.$frame=t},updateData:function(){this.photoAspectRatioCorrected=!1;var e=Poof.retainContext(this,function(){if(this.$photo.width()>0&&this.$photo.height()>0){this.photoAspectRatio=this.$photo.width()/this.$photo.height();this.photoAspectRatioCorrected=!0;this.updateFrame()}else setTimeout(e,10)});e()},enable:function(){this.enabled=!0;$(document).bind(Modernizr.touch?"touchstart.reposition":"mousedown.reposition",Poof.retainContext(this,this.onTouchStart));$(document).bind(Modernizr.touch?"touchend.reposition":"mouseup.reposition",Poof.retainContext(this,this.onTouchEnd));$(document).bind(Modernizr.touch?"touchmove.reposition":"mousemove.reposition",Poof.retainContext(this,this.onTouchMove))},disable:function(){this.enabled=!1;$(document).unbind("touchstart.reposition");$(document).unbind("touchend.reposition");$(document).unbind("touchmove.reposition");$(document).unbind("mousedown.reposition");$(document).unbind("mouseup.reposition");$(document).unbind("mousemove.reposition")},getPositionInfoObject:function(){var e=$(window).height(),t=e*PhotoPositionController.OVERLAY_ASPECT_RATIO;return{position:{left:(parseInt(this.$photo.css("left"),10)+parseInt(this.$photo.css("margin-left"),10)-($(window).width()-t)*.5)/t,top:(parseInt(this.$photo.css("top"),10)+parseInt(this.$photo.css("margin-top"),10))/e},size:{width:this.$photo.width()/t,height:this.$photo.height()/e},orientation:{rotation:this.photoRotation}}},updateFrame:function(){var e=this.$photo.width()>0?this.$photo.width():PhotoPositionController.INITIAL_PHOTO_WIDTH,t=this.$photo.height()>0?this.$photo.height():e/this.photoAspectRatio;this.$frame.css("width",e);this.$frame.css("height",t);this.$frame.css("top",this.$photo.css("top"));this.$frame.css("left",this.$photo.css("left"));this.$frame.css("margin-left",parseFloat(this.$photo.css("margin-left"),10)-2);this.$frame.css("margin-top",parseFloat(this.$photo.css("margin-top"),10)-2);this.$frame.rotate(this.photoRotation)},setInitialPosition:function(){var e=$(window).height()*PhotoPositionController.INITIAL_PHOTO_WIDTH;this.$photo.css("width",e+"px");this.$photo.css("left",.5*$(window).width()-e*.5);this.$photo.css("top",PhotoPositionController.INITIAL_PHOTO_OFFSET_TOP*$(window).height()-e*.5/this.photoAspectRatio);this.updateFrame()},registerStartValues:function(e){e=e.originalEvent;this.controlModePosition=!0;if(e.touches){if(this.numTouches===0){this.photoStartPosition={x:parseInt(this.$photo.css("left"),10),y:parseInt(this.$photo.css("top"),10)};this.startPos1={x:e.touches[0].pageX,y:e.touches[0].pageY};this.lastPos1={x:this.startPos1.x,y:this.startPos1.y};this.numTouches=1;if(e.touches.length>1){this.photoStartSize={width:this.$photo.width(),height:this.$photo.height()};this.photoStartMargins={left:parseFloat(this.$photo.css("margin-left"),10),top:parseFloat(this.$photo.css("margin-top"),10)};this.photoStartRotation=this.photoRotation;this.startPos1b={x:this.startPos1.x,y:this.startPos1.y};this.startPos2={x:e.touches[1].pageX,y:e.touches[1].pageY};this.lastPos2={x:this.startPos2.x,y:this.startPos2.y};this.controlModeScale=!0;this.controlModeRotation=!0;this.controlModePosition=!1;this.numTouches=2}}else if(this.numTouches===1){this.photoStartSize={width:parseInt(this.$photo.css("width"),10),height:parseInt(this.$photo.css("height"),10)};this.photoStartMargins={left:parseFloat(this.$photo.css("margin-left"),10),top:parseFloat(this.$photo.css("margin-top"),10)};this.photoStartRotation=this.photoRotation;this.startPos1b={x:this.lastPos1.x,y:this.lastPos1.y};this.startPos2={x:e.touches[1].pageX,y:e.touches[1].pageY};this.lastPos2={x:this.startPos2.x,y:this.startPos2.y};this.controlModeScale=!0;this.controlModeRotation=!0;this.controlModePosition=!1;this.numTouches=2}}else{this.numTouches=1;this.startPos1={x:e.pageX,y:e.pageY}}},registerEndValues:function(e){e=e.originalEvent;this.controlModeScale=this.controlModeRotation=!1;if(e.touches)if(e.touches.length>1){this.controlModePosition=!1;this.numTouches=0}else if(this.numTouches>1&&e.touches&&e.touches.length>0){var t={x:e.touches[0].pageX-this.lastPos1.x,y:e.touches[0].pageY-this.lastPos1.y},n={x:e.touches[0].pageX-this.lastPos2.x,y:e.touches[0].pageY-this.lastPos2.y},r=t.x*t.x+t.y*t.y,i=n.x*n.x+n.y*n.y;if(r<i){this.numTouches=this.numTouches>1?1:0;this.photoStartPosition={x:parseInt(this.$photo.css("left"),10),y:parseInt(this.$photo.css("top"),10)};this.startPos1={x:this.lastPos1.x,y:this.lastPos1.y};this.controlModePosition=!0}else{this.controlModePosition=!1;this.numTouches=0}}else{this.controlModePosition=!1;this.numTouches=0}else{this.numTouches=0;this.controlModePosition=!1}},registerMoveValues:function(e){e=e.originalEvent;if(e.touches){this.lastPos1={x:e.touches[0].pageX,y:e.touches[0].pageY};e.touches.length>1&&(this.lastPos2={x:e.touches[1].pageX,y:e.touches[1].pageY})}else this.lastPos1={x:e.pageX,y:e.pageY};this.controlModePosition&&this.applyPosition();this.controlModeRotation&&this.applyRotation();this.controlModeScale&&this.applyScale();this.applyConstraints()},applyPosition:function(){var e={x:this.lastPos1.x-this.startPos1.x,y:this.lastPos1.y-this.startPos1.y},t=this.photoStartPosition.x+e.x,n=this.photoStartPosition.y+e.y;this.$photo.css("left",t);this.$photo.css("top",n)},applyRotation:function(){this.controlModePosition=!1;var e={x:this.startPos2.x-this.startPos1b.x,y:this.startPos2.y-this.startPos1b.y},t={x:this.lastPos2.x-this.lastPos1.x,y:this.lastPos2.y-this.lastPos1.y},n=Math.atan2(e.y,e.x),r=Math.atan2(t.y,t.x);this.photoRotation=(r-n)*180/Math.PI+this.photoStartRotation;this.$photo.rotate(this.photoRotation)},applyScale:function(){this.controlModePosition=!1;var e={x:this.startPos2.x-this.startPos1b.x,y:this.startPos2.y-this.startPos1b.y},t={x:this.lastPos2.x-this.lastPos1.x,y:this.lastPos2.y-this.lastPos1.y},n=Math.sqrt(e.x*e.x+e.y*e.y),r=Math.sqrt(t.x*t.x+t.y*t.y),i=r/n,s=this.photoStartSize.width*i,o=s/this.photoAspectRatio,u=s-this.photoStartSize.width,a=$(window).height()*PhotoPositionController.MIN_PHOTO_WIDTH,f=$(window).height()*PhotoPositionController.MIN_PHOTO_HEIGHT,l=$(window).height()*PhotoPositionController.MAX_PHOTO_WIDTH,c=$(window).height()*PhotoPositionController.MAX_PHOTO_HEIGHT;if(s>a&&o>f&&s<l&&o<c){this.$photo.css("width",s);this.$photo.css("height",s/this.photoAspectRatio);this.$photo.css("margin-left",-u*.5+this.photoStartMargins.left);this.$photo.css("margin-top",-u*.5/this.photoAspectRatio+this.photoStartMargins.top)}},applyConstraints:function(){var e=0,t=$(window).width()-this.$photo.width(),n=0,r=$(window).height()*.5;e-=parseFloat(this.$photo.css("margin-left"));n-=parseFloat(this.$photo.css("margin-top"));t-=parseFloat(this.$photo.css("margin-left"));r+=parseFloat(this.$photo.css("margin-top"));var i=parseFloat(this.$photo.css("left")),s=parseFloat(this.$photo.css("top"));i<e?i=e:i>t&&(i=t);s<n?s=n:s>r&&(s=r);this.$photo.css("left",i);this.$photo.css("top",s)},onTouchStart:function(e){this.photoAspectRatioCorrected&&this.registerStartValues(e)},onTouchEnd:function(e){this.photoAspectRatioCorrected&&this.registerEndValues(e)},onTouchMove:function(e){if(this.photoAspectRatioCorrected){this.registerMoveValues(e);this.updateFrame()}}}})]);